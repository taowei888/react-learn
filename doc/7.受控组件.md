# React 受控组件理解和应用

## React 受控组件

受控组件是指表单元素的值由 React 的 State 管理。更新数据时，需要手动调用 `setState()` 方法来更新数据。由于 React 没有类似 Vue 的 `v-model` 指令，需要手动实现数据绑定事件。

### 为什么使用受控组件？

使用受控组件的优势：

- **数据同步**：确保表单数据与组件状态保持同步
- **集中管理**：便于统一管理和验证表单数据
- **灵活控制**：可以在输入过程中进行数据格式化、验证和 UI 联动
- **单一数据源**：组件的 state 成为"唯一数据源"

### 基础案例

当我们在界面的输入框中输入内容时，如果只设置了 `value` 而没有 `onChange` 处理器，输入框将变成只读状态，并且 React 会发出警告：

> You provided a `value` prop to a form field without an `onChange` handler. This will render a read-only field. If the field should be mutable use `defaultValue`. Otherwise, set either `onChange` or `readOnly`.

**错误示例**（只读输入框）：

```tsx
import React, { useState } from 'react';

const App: React.FC = () => {
  const [value, setValue] = useState('')
  return (
    <>
      <input type="text" value={value} />
      <div>{value}</div>
    </>
  );
}

export default App;
```

当用户输入内容时，`value` 并不会自动更新，需要手动实现 `onChange` 事件来更新 state。

**正确示例**（受控组件）：

```tsx
import React, { useState } from 'react';

const App: React.FC = () => {
  const [value, setValue] = useState('123')
  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setValue(e.target.value)
  }
  return (
    <>
      <input type="text" value={value} onChange={handleChange} />
      <div>{value}</div>
    </>
  );
}

export default App;
```

这样就实现了类似 Vue 的 `v-model` 机制：通过 `onChange` 事件来更新 `value`，实现双向数据绑定。

> **提示**：受控组件适用于大多数表单元素，包括 `input`、`textarea`、`select` 等。但 `input type="file"` 是个例外，它只能作为非受控组件使用。

---

## React 非受控组件

非受控组件是指表单元素不受 React 的 State 管理，表单数据由 DOM 自身管理。通过 `useRef()` 来获取表单元素的值。

### 基础用法

使用 `defaultValue` 设置表单的默认值，通过 `ref` 来访问 DOM 元素并获取当前值。

```tsx
import React, { useRef } from 'react';

const App: React.FC = () => {
  const value = '456'
  const inputRef = useRef<HTMLInputElement>(null)
  const handleChange = () => {
    console.log(inputRef.current?.value)
  }
  return (
    <>
      <input
        type="text"
        onChange={handleChange}
        defaultValue={value}
        ref={inputRef}
      />
    </>
  );
}

export default App;
```

### 受控组件 vs 非受控组件

| 特性 | 受控组件 | 非受控组件 |
|------|---------|-----------|
| 数据管理 | React State | DOM |
| 获取值 | 直接从 state 读取 | 通过 ref 访问 DOM |
| 默认值 | `value` + `onChange` | `defaultValue` |
| 适用场景 | 需要验证、格式化、实时响应 | 简单表单、文件上传 |

---

## 特殊的表单：File 输入框

对于 `<input type="file">` 元素，它是一个特殊的组件。它的值只能由用户通过文件选择操作来设置，**不能通过程序直接设置**。这使得它在 React 中的处理方式与其他表单元素有所不同。

### 为什么 File 输入框不能受控？

由于浏览器安全限制，`<input type="file">` 的 `value` 属性：
- ✅ 可以设置为空字符串（用于清空）
- ❌ 不能设置为文件对象或文件路径

因此，文件输入框**必须作为非受控组件使用**。

### 错误示例（尝试受控）

```tsx
import React, { useState } from 'react';

const App: React.FC = () => {
  const [files, setFiles] = useState<File | null>(null)
  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setFiles(e.target.files?.[0]!)
  }
  return (
    <>
      {/* ❌ 错误：不能将 File 对象设置为 value */}
      <input type="file" value={files} onChange={handleChange} />
    </>
  );
}

export default App;
```

**TypeScript 错误**：
```
不能将类型"File | null"分配给类型"string | number | readonly string[] | undefined"。
```

### 正确示例（非受控组件）

```tsx
import React, { useRef } from 'react';

const App: React.FC = () => {
  const inputFileRef = useRef<HTMLInputElement>(null)
  const handleChange = () => {
    console.log(inputFileRef.current?.files)
  }
  return (
    <>
      <input type="file" ref={inputFileRef} onChange={handleChange} />
    </>
  );
}

export default App;
```

### File 输入框最佳实践

**1. 获取选中的文件**

```tsx
const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0]
  if (file) {
    console.log('文件名:', file.name)
    console.log('文件大小:', file.size)
    console.log('文件类型:', file.type)
  }
}
```

**2. 清空文件选择**

```tsx
const clearFile = () => {
  if (inputFileRef.current) {
    inputFileRef.current.value = '' // 设置为空字符串来清空
  }
}
```

**3. 限制文件类型**

```tsx
<input
  type="file"
  accept=".jpg,.png,.pdf"  // 限制可选文件类型
  onChange={handleChange}
  ref={inputFileRef}
/>
```

**4. 多文件选择**

```tsx
<input
  type="file"
  multiple  // 允许选择多个文件
  onChange={(e) => {
    const files = Array.from(e.target.files || [])
    console.log('选中的文件:', files)
  }}
  ref={inputFileRef}
/>
```

---

## 总结

- **受控组件**：由 React State 管理，使用 `value` + `onChange`，适合需要验证和实时响应的场景
- **非受控组件**：由 DOM 管理，使用 `defaultValue` + `ref`，适合简单表单和文件上传
- **File 输入框**：由于安全限制，只能作为非受控组件使用，通过 `ref` 访问文件数据
- **选择建议**：优先使用受控组件，除非是文件上传或对性能有极高要求的场景
